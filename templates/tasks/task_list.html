{% extends 'base.html' %}
{% block title %}Tasks{% endblock %}
{% block content %}
<div class="row">
  <div class="col-12 col-lg-10 mx-auto">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0">Tasks</h1>
      <a href="{% url 'task_create' %}" class="btn btn-primary">+ New Task</a>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-success py-2">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <!-- Search & Filter -->
    <form method="get" class="mb-3">
      <div class="row g-2">
        <div class="col-md-6">
          <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Search by title or description..."
            value="{{ q }}"
          >
        </div>
        <div class="col-md-3">
          <select name="status" class="form-select">
            <option value="">All statuses</option>
            <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
            <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>In Progress</option>
            <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
          </select>
        </div>
        <div class="col-md-3 d-flex">
          <button type="submit" class="btn btn-primary me-2 flex-grow-1">Apply</button>
          <a href="{% url 'task_list' %}" class="btn btn-outline-light">Reset</a>
        </div>
      </div>
    </form>

    <div class="card card-custom">
      <div class="card-body p-0">
        {% if page_obj.object_list %}
          <div class="table-responsive">
            <table class="table table-striped mb-0 align-middle table-custom table-tasks">
              <thead>
                <tr>
                  <th style="width:6%">ID</th>
                  <th>Title</th>
                  <th>Status</th>
                  <th>Assigned To</th>
                  <th>Due Date</th>
                  <th>Created At</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for task in page_obj.object_list %}
                  <tr data-task-id="{{ task.id }}">
                    {# sequential id across pages: start_index + forloop.counter0 -> 1-based sequence #}
                    <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                    <td>{{ task.title }}</td>
                    <td class="task-status">{{ task.get_status_display }}</td>
                    <td>{{ task.assigned_to.username }}</td>
                    <td>{{ task.due_date }}</td>
                    <td>{{ task.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="text-end">
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-info me-2 toggle-status-btn"
                        data-task-id="{{ task.id }}"
                      >
                        {% if task.status != 'completed' %}
                          Mark as completed
                        {% else %}
                          Mark as pending
                        {% endif %}
                      </button>

                      <a href="{% url 'task_update' task.pk %}"
                         class="btn btn-sm btn-outline-light me-2">Edit</a>
                      <a href="{% url 'task_delete' task.pk %}"
                         class="btn btn-sm btn-outline-danger">Delete</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="p-3 mb-0">No tasks found. <a href="{% url 'task_create' %}">Create one</a>.</p>
        {% endif %}
      </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
      <nav class="mt-3">
        <ul class="pagination justify-content-center">

          {% with qparam="" %}
            {% if q %}
              {% firstof qparam "" %}
            {% endif %}
          {% endwith %}

          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
                Previous
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Previous</span>
            </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% else %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ num }}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
                  {{ num }}
                </a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
                Next
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Next</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Ajax toggle status
document.addEventListener('click', function (e) {
  if (e.target.classList.contains('toggle-status-btn')) {
    const btn = e.target;
    const taskId = btn.getAttribute('data-task-id');

    fetch(`/tasks/${taskId}/toggle-status/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // status update
        const row = btn.closest('tr');
        const statusCell = row.querySelector('.task-status');
        statusCell.textContent = data.status_display;
//updating the text button 
        if (data.status === 'completed') {
          btn.textContent = 'Mark as pending';
        } else {
          btn.textContent = 'Mark as completed';
        }
      } else {
        alert('Could not update status.');
      }
    })
    .catch(() => {
      alert('Error updating status.');
    });
  }
});
</script>
{% endblock %}
